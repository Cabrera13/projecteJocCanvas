<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<style>
html, body {
    height: 100vh;
}
body {
    display: flex; 
    align-items:center; 
    justify-content: center;
}
canvas {
    border:1px solid #d3d3d3;
    background-color: #f1f1f1;
}

 img {
    display: none;
 }
</style>

</head>
<body onload="startGame()">

<audio id="megamanMusic">   
  <source src="megaman.mp3" type="audio/mpeg">
</audio>

<audio id="jump">   
  <source src="jump.mp3" type="audio/mpeg">
</audio>
<audio id="death">   
  <source src="gameover.mp3" type="audio/mpeg">
</audio>

<img src="spriterino2.png" id ="gamesprites"/>
<img src="mainscreengame.png" id ="gamesprites2"/>
<img src="controls.png" id ="gamesprites3"/>
<img src="credits.png" id ="gamesprites4"/>
<img src="gameover.png" id ="gamesprites5"/>
<img src="megamanlogo.png" id ="gamesprites6"/>

<script>
    var imatge = document.getElementById("gamesprites");
    var imatge2 = document.getElementById("gamesprites2");
    var imatge3 = document.getElementById("gamesprites3");
    var imatge4 = document.getElementById("gamesprites4");
    var imatge5 = document.getElementById("gamesprites5");
    var imatge6 = document.getElementById("gamesprites6");

    var musicGame= document.getElementById("megamanMusic");
    var musicJump = document.getElementById("jump");
    var dead = document.getElementById("death");
    var score = [];
    var allComponentScores = [];
    var array = [];
    var array2 = [];
    var myGamePiece;
    var myObstacles = [];
    var myScore;
    var numsprite = 1;
    var positionY = 0;
    var terra = 270;
    var spriteLogo =[{x:0, y:0, w: 400, h:50}];
    var background=[
        {x:93, y:1, w: 480, h: 279},
        {x:24, y:49, w: 50, h: 145},
        {x:588, y:0, w: 101, h: 128}
    ]
    var sprites=[
        {x:32, y:6, w: 22, h: 30},
        {x:54, y:6, w: 16, h: 30},
        {x:5, y:2, w: 28, h: 30}
    ];
    var backgroundMenuPrincipal =[
        {x:0, y:0, w:606, h:465},
        {x:638,y:36,w:270,h:57},
        {x:657,y:126,w:280,h:119}
    ];
    var posicionsDelMenu = 0;
    var blockspeed = 1;
    
    var createblock = true;
    
    var count = 0;
    var crash;

    function startGame() {        
        myGamePiece = new component(19, 24, "none", 80, 480, "sprite");
        blockspeed = 1;
        myGamePiece.gravity = 0.1;
        myScore = new component("20px", "Copperplate Gothic Light", "white", 300, 30, "text");
        myGameArea.start();             
    }
    
    var myGameArea = {
        canvas : document.createElement("canvas"),
        start : function() {
            this.canvas.width = 480;
            this.canvas.height = 270;
            this.canvas.style.top = "100";
            this.context = this.canvas.getContext("2d");
            document.body.insertBefore(this.canvas, document.body.childNodes[0]);
            this.frameNo = 0;
            if (posicionsDelMenu == 0) {
                drawbackground2();
            }
            if (posicionsDelMenu == 1){
                megamanMusic.play();
                this.interval = setInterval(updateGameArea, 20);
            }
            if (posicionsDelMenu == 2) {
                drawStaticBackgroundControls();
            }
            if (posicionsDelMenu == 3) {
                drawCreditMenu();
            }
            if (posicionsDelMenu == 4) {
                gameOver();
            }
        },
        clear : function() {
            this.context.clearRect(0, 0, this.canvas.width, this.canvas.height);
        }
    }
    function drawCreditMenu () {
        myGameArea.canvas.removeEventListener('mousemove', hola);
        myGameArea.canvas.removeEventListener('click', hola2);
        ctx = myGameArea.context;
        var sprite = backgroundMenuPrincipal[0]; 
        ctx.drawImage(imatge4, sprite.x, sprite.y, sprite.w, sprite.h, -2, -2, sprite.w-110, sprite.h-190);  
        setTimeout(function() {posicionsDelMenu = 0; myGameArea.canvas.removeEventListener('mousemove', hola);myGameArea.canvas.removeEventListener('click', hola2);
        myGameArea.clear(); myGameArea.start();}, 3000);
    }
    function gameOver() {
        myGameArea.canvas.removeEventListener('mousemove', hola);
        myGameArea.canvas.removeEventListener('click', hola2);
        ctx = myGameArea.context;
        var sprite = backgroundMenuPrincipal[0]; 
        ctx.drawImage(imatge5, sprite.x, sprite.y, sprite.w, sprite.h, -2, -2, sprite.w+100, sprite.h);  
        sprite2 = new component("30px", "Copperplate Gothic Light", "white", 350, 260, "text");
        sprite2.text = "return";
        sprite2.update();

        score.sort(function(a,b) { return b - a; });
        if (score.length > 5) {
            score.pop();
        }

        score.map((elem, i) => {
            allComponentScores.push(new component("20px", "Impact", "white", 200, 160+positionY, "text" ));
            allComponentScores[i].text = score[i];
            allComponentScores[i].update();
            positionY+= 20;
        });



        myGameArea.canvas.addEventListener('mousemove', hola = function (evt) {
            var mousePos = getCursorDeadMenu(myGameArea.canvas, evt);
          }, false);
            myGameArea.canvas.addEventListener('click', hola2 = function (evt) {
            var mousePos = getCursorDeadMenuclick(myGameArea.canvas, evt);
          }, false);
    }
    function getCursorDeadMenu () {
            var rect = myGameArea.canvas.getBoundingClientRect();
            var x = event.clientX - rect.left;
            var y = event.clientY - rect.top;  
            if ((x >=353) && (y >= 244) && (x<=461) && (y <= 261)) {
                array[3] = new component("30px", "Copperplate Gothic Light", "red", 350, 260, "text");
                array[3].text="return";
                array[3].update();
            }          
            else {
                array[3] = new component("30px", "Copperplate Gothic Light", "white", 350, 260, "text");
                array[3].text="return";
                array[3].update();       
            }
            console.log("x: " + x + " y: " + y);        
    }
    function getCursorDeadMenuclick () {
        var rect = myGameArea.canvas.getBoundingClientRect();
        var x = event.clientX - rect.left;
        var y = event.clientY - rect.top;
        if ((x >=353) && (y >= 244) && (x<=461) && (y <= 261)) {
            posicionsDelMenu = 0;
            myGameArea.canvas.removeEventListener('mousemove', hola);
            myGameArea.canvas.removeEventListener('click', hola2);
            myGameArea.clear();
            myGameArea.start();
        }
        console.log("x: " + x + " y: " + y);        
    }
    function drawbackground() {
        myGameArea.canvas.removeEventListener('mousemove', hola);
        myGameArea.canvas.removeEventListener('click', hola2);
        ctx = myGameArea.context;
        var sprite = background[0]; 
        ctx.drawImage(imatge, sprite.x, sprite.y, sprite.w, sprite.h, -2, -2, sprite.w+10, sprite.h);  
}
    function drawStaticBackgroundControls () {
        myGameArea.canvas.removeEventListener('mousemove', hola);
        myGameArea.canvas.removeEventListener('click', hola2);
        ctx = myGameArea.context;
        var sprite = backgroundMenuPrincipal[0]; 
        ctx.drawImage(imatge3, sprite.x, sprite.y, sprite.w, sprite.h, -2, -2, sprite.w-110, sprite.h-190);  
        sprite2 = new component("30px", "Copperplate Gothic Light", "white", 350, 30, "text");
        sprite2.text = "return";
        sprite2.update();
        myGameArea.canvas.addEventListener('mousemove', hola = function (evt) {
            var mousePos = getCursorPositionMenuControls(myGameArea.canvas, evt);
          }, false);
            myGameArea.canvas.addEventListener('click', hola2 = function (evt) {
            var mousePos = getCursorPositionMenuControlsClick(myGameArea.canvas, evt);
          }, false);
    }
    function drawbackground2() {
        ctx = myGameArea.context;
        var sprite = backgroundMenuPrincipal[0]; 
        var sprite2 = backgroundMenuPrincipal[1]; 
        var sprite3 = backgroundMenuPrincipal[2];
        sprite4 = spriteLogo[0];
        ctx.drawImage(imatge2, sprite.x, sprite.y, sprite.w, sprite.h, -2, -2, sprite.w-110, sprite.h-190);  
        ctx.drawImage(imatge6, sprite4.x-120, sprite4.y-40, sprite4.w+600, sprite4.h+240, 2, 2, sprite4.w, sprite4.h);
        array.push(new component("30px", "Copperplate Gothic Light", "white", 190, 100, "text"));
        array.push(new component("30px", "Copperplate Gothic Light", "white", 130, 160, "text"));
        array.push(new component("30px", "Copperplate Gothic Light", "white", 170, 220, "text"));
        array[0].text="START";
        array[1].text="HELP SCREEN";
        array[2].text="CREDITS";
        array[0].update();
        array[1].update();
        array[2].update();

          myGameArea.canvas.addEventListener('mousemove', hola = function (evt) {
            var mousePos = getCursorPosition(myGameArea.canvas, evt);
          }, false);
            myGameArea.canvas.addEventListener('click', hola2 = function (evt) {
            var mousePos = getCursorPosition2(myGameArea.canvas, evt);
          }, false);
}
        function getCursorPositionMenuControls (canvas, event) {
            var rect = myGameArea.canvas.getBoundingClientRect();
            var x = event.clientX - rect.left;
            var y = event.clientY - rect.top;  
            if ((x >=352) && (y >= 15) && (x<=448) && (y <= 31)) {
                array[3] = new component("30px", "Copperplate Gothic Light", "red", 350, 30, "text");
                array[3].text="return";
                array[3].update();
            }          
            else {
                array[3] = new component("30px", "Copperplate Gothic Light", "white", 350, 30, "text");
                array[3].text="return";
                array[3].update();       
            }
            console.log("x: " + x + " y: " + y);
        }
        function getCursorPosition(canvas, event) {
            var rect = myGameArea.canvas.getBoundingClientRect();
            var x = event.clientX - rect.left;
            var y = event.clientY - rect.top;
            if ((x >=192) && (y >= 81) && (x<=300) && (y <= 99)) {
                array[0] = new component("30px", "Copperplate Gothic Light", "red", 190, 100, "text");
                array[0].text="START";
                array[0].update();
            }
            else {
                array[0] = new component("30px", "Copperplate Gothic Light", "white", 190, 100, "text");
                array[0] .text="START";
                array[0] .update();

            }
            if ((x >=131) && (y >= 140) && (x<=364) && (y <= 162)) {
                array[1] = new component("30px", "Copperplate Gothic Light", "red", 130, 160, "text");
                array[1].text="HELP SCREEN";
                array[1].update();
            }
            else {
                array[1] = new component("30px", "Copperplate Gothic Light", "white", 130, 160, "text");
                array[1].text="HELP SCREEN";
                array[1].update();
            }
            if ((x >=172) && (y >= 199) && (x<=316) && (y <= 220)) {
                array[2] = new component("30px", "Copperplate Gothic Light", "red", 170, 220, "text");
                array[2].text="CREDITS";
                array[2].update();
            }
            else {
                array[2] = new component("30px", "Copperplate Gothic Light", "white", 170, 220, "text");
                array[2].text="CREDITS";
                array[2].update();
            }
            console.log("x: " + x + " y: " + y);
        }
        function getCursorPosition2(canvas, event) {
            var rect = myGameArea.canvas.getBoundingClientRect();
            var x = event.clientX - rect.left;
            var y = event.clientY - rect.top;
            if ((x >=192) && (y >= 81) && (x<=300) && (y <= 99)) {
                posicionsDelMenu = 1;
                myGameArea.clear();
                myGameArea.start();
            }
            if ((x >=131) && (y >= 140) && (x<=364) && (y <= 162)) {
                posicionsDelMenu = 2;
                myGameArea.clear();
                myGameArea.start();
            }
            if ((x >=172) && (y >= 199) && (x<=316) && (y <= 220)) {
                posicionsDelMenu = 3;
                myGameArea.clear();
                myGameArea.start();
            }

            console.log("x: " + x + " y: " + y);
        }
        function getCursorPositionMenuControlsClick(canvas, event) {
                    var rect = myGameArea.canvas.getBoundingClientRect();
                    var x = event.clientX - rect.left;
                    var y = event.clientY - rect.top;
                    if ((x >=352) && (y >= 15) && (x<=448) && (y <= 31)) {
                        posicionsDelMenu = 0;
                        myGameArea.canvas.removeEventListener('mousemove', hola);
                        myGameArea.canvas.removeEventListener('click', hola2);
                        myGameArea.clear();
                        myGameArea.start();
                    }
                    console.log("x: " + x + " y: " + y);
                }

    
    
    function drawspikes() {
        
        ctx = myGameArea.context;
        var sprite = background[1]; 
        if (count < 10) {
            ctx.drawImage(imatge, sprite.x, sprite.y, sprite.w, sprite.h, -2, -2, sprite.w, sprite.h);
            ctx.drawImage(imatge, sprite.x, sprite.y, sprite.w, sprite.h, -2, -2+sprite.h, sprite.w, sprite.h);        
        }
        else if (count <= 20) {
            ctx.drawImage(imatge, sprite.x, sprite.y, sprite.w, sprite.h, 0, -2, sprite.w, sprite.h);
            ctx.drawImage(imatge, sprite.x, sprite.y, sprite.w, sprite.h, 0, -2+sprite.h, sprite.w, sprite.h); 
            if (count == 20){
                count = 0;
            }                           
        }
    }
    
    function component(width, height, color, x, y, type) {
        this.type = type;
        this.score = 0;
        this.width = width;
        this.height = height;
        this.x = x;
        this.y = y;
        this.speedY = 0;
        this.speedX = 0;
        this.gravity = 0;
        this.gravitySpeed = 0;
        this.right = false;
        this.left = false;

        this.update = function() {
            ctx = myGameArea.context;
            if (this.type == "sprite") {
                var sprite = sprites[numsprite];    
                if (count < 10) {
                    numsprite = 0;                
                }
                else if (count <= 20) {
                    numsprite=1;
                    if (count == 20){
                        count = 0;
                    }                           
                }
                ctx.drawImage(imatge, sprite.x, sprite.y, sprite.w, sprite.h, this.x, this.y, sprite.w, sprite.h);
                count+=1;
                
                document.body.onkeydown = function(event){
                    event = event || window.event;
                    var keycode = event.charCode || event.keyCode;
                    if(keycode === 32 || keycode === 87 || keycode === 38){
                        if ((myGamePiece.y + (myGamePiece.height)) >= terra) {
                            myGamePiece.jump();
                        }
                    } else if(keycode === 39 || keycode === 68){
                        myGamePiece.right = true;
                    } else if(keycode === 37 || keycode === 65){
                        myGamePiece.left = true;
                    }              
                }
            
                document.body.onkeyup = function(event){
                    event = event || window.event;
                    var keycode = event.charCode || event.keyCode;
                    if(keycode === 39 || keycode === 68){
                        myGamePiece.right = false;
                    } else if(keycode === 37 || keycode === 65){
                        myGamePiece.left = false;
                    }
                }
                
                if (myGamePiece.right)
                    myGamePiece.moveRight();
                if (myGamePiece.left)
                    myGamePiece.moveLeft();
                
            }
            else if  (this.type == "text") {
                ctx.font = this.width + " " + this.height;
                ctx.fillStyle = color;
                ctx.fillText(this.text, this.x, this.y);
            } else {
                ctx.drawImage(imatge, background[2].x, background[2].y, background[2].w, background[2].h, this.x, this.y, background[2].w, background[2].h);
            }
        }
        this.newPos = function() {
            this.gravitySpeed += this.gravity;
            this.y += this.speedY + this.gravitySpeed;
            this.hitBottom();
            this.hitObstacles();
            
        }
        this.hitBottom = function() {
            var rockbottom = myGameArea.canvas.height - this.height;
            if (this.y > rockbottom) {
                this.y = rockbottom;
            }
        }
        this.hitObstacles = function() {
            for (i = 0; i < myObstacles.length; i += 1) {
                if (myGamePiece.crashWith(myObstacles[i])) {
                    gravitySpeed = 0;
                } 
            }
        }
        
        this.jump = function () {
            musicJump.pause();
            musicJump.currentTime=0.5;
            if (posicionsDelMenu == 1) {
            musicJump.play();
            this.gravitySpeed = -3;
        }
        }
        
        this.moveRight = function () {
            if ((this.x+(this.width))<480)
                this.x += 1;                
        }
        this.moveLeft = function () {
            if (this.x>0)
                this.x -= 1;                
        }
            
        this.getright = function() {
            return (this.x + (this.width));
        }
        
        this.crashWith = function(otherobj) {
            var myleft = this.x;
            var myright = this.x + (this.width);
            var mytop = this.y;
            var mybottom = this.y + (this.height);
            var otherleft = otherobj.x;
            var otherright = otherobj.x + (otherobj.width);
            var othertop = otherobj.y;
            var otherbottom = otherobj.y + (otherobj.height);
            var crash = true;
            var rockbottom2 = myGameArea.canvas.height - myGamePiece.height;
            if ((mybottom < othertop) || (mytop > otherbottom) || (myright < otherleft) || (myleft > otherright)) {
                crash = false;
            }
            if ((myright >= otherleft) && (mybottom > othertop) && (myright < otherleft+10) && (crash)) {
                this.x = otherobj.x-19;
                numsprite = 1;
            } else if ((mybottom >= othertop) && (crash)) {
                this.y = otherobj.y-24;
                this.gravitySpeed=0;
                terra = othertop;
            } else if (mybottom<terra){
                numsprite=2;
                terra = 270;
            }        
            if (myGamePiece.x < 52.5){
                death();
            }
        }
    }
    
    function death() {
        score.push(myGameArea.frameNo);
        clearInterval(myGameArea.interval);
        posicionsDelMenu = 4;
        musicGame.pause();
        dead.currentTime = 0.50;
        dead.play();
        sleep(1000);
        musicGame.currentTime=0;
        myGameArea.clear();
        startGame();
        myObstacles=[];
        createblock = true;
    }
    
    function updateGameArea() {
        var x, height, minHeight, maxHeight;
        myGameArea.clear();
        drawbackground();
        myGameArea.frameNo += 1;
        if (createblock) {
            createblock = false;
            x = myGameArea.canvas.width;
            minHeight = 70;
            maxHeight = 90;
            height = 100;
            midaFinal = 240;
            if (myObstacles.length != 0) {
                mida = myObstacles[myObstacles.length-1].height;
                midaFinal= getRandomInt(270,mida+10);
            }
            myObstacles.push(new component(100, x - midaFinal, "blue", x, midaFinal));
        }
        if (myObstacles[myObstacles.length-1].x+90<=480){
            createblock = true;
        }
        for (i = 0; i < myObstacles.length; i += 1) {
            myObstacles[i].x += -blockspeed;
            myObstacles[i].update();
            if (blockspeed<8)
                blockspeed=blockspeed*1.00001;
            else
                blockspeed=8
        }
        drawspikes();
        myScore.text="SCORE: " + myGameArea.frameNo;
        myScore.update();
        myGamePiece.newPos();
        myGamePiece.update();
    }
    
    function everyinterval(n) {
        if ((myGameArea.frameNo / n) % 1 == 0) {return true;}
        return false;
    }
    
    function getRandomInt(min, max) {
        return Math.floor(Math.random() * (max - min + 1)) + min;
    }
    function sleep(miliseconds) {
       var currentTime = new Date().getTime();

       while (currentTime + miliseconds >= new Date().getTime()) {
       }
    }
</script>
<br>
</body>
</html>
